[![Go Report Card](https://goreportcard.com/badge/github.com/kafkaesque-io/pulsar-monitor)](https://goreportcard.com/report/github.com/kafkaesque-io/pulsar-monitor)
[![CI Build](https://github.com/kafkaesque-io/pulsar-monitor/workflows/ci/badge.svg
)](https://github.com/kafkaesque-io/pulsar-monitor/actions)
[![codecov](https://codecov.io/gh/kafkaesque-io/pulsar-monitor/branch/master/graph/badge.svg)](https://codecov.io/gh/kafkaesque-io/pulsar-monitor)
[![Language](https://img.shields.io/badge/Language-Go-blue.svg)](https://golang.org/)
[![Docker image](https://img.shields.io/docker/image-size/kesque/pulsar-monitor)](https://hub.docker.com/r/kesque/pulsar-monitor/)
[![LICENSE](https://img.shields.io/hexpm/l/pulsar.svg)](https://github.com/kafkaesque-io/pulsar-monitor/blob/master/LICENSE)

# Operation Monitoring for Pulsar Cluster
Pulsar Monitor monitors the availablitliy, tracks the performance, and reports failures of Pulsar cluster. It produces synthetic workloads to measure end-to-end message pubsub latency.

It is a cloud native application that can be installed by Helm within Pulsar kubernetes cluster.

Here is a list of features that Pulsar Monitor supports.
- [x] monitor Pulsar admin REST API endpoint
- [x] measure end-to-end message latency from producing to consuming messages
- [x] for latency measure, it can produce a list of messages with user specified payload size and the number of messages
- [x] measure average latency over a list of messages
- [x] detect out of order delivery of a list of generated messages
- [x] measure a single message latency over the websocket interface
- [x] measure message latency generated by Pulsar function
- [x] monitor instance availabitily of broker, proxy, bookkeeper, and zookeeper in a Pulsar Kubernetes cluster
- [x] monitor individual Pulsar broker's health
- [ ] Pulsar function trigger over HTTP interface
- [x] incident alert with OpsGenie with automatic alert clear and deduplication
- [x] customer configurable alert threshold and probe test interval
- [x] tracking analytics and usage
- [x] dead man's snitch heartbeat monitor with OpsGenie
- [x] alert on Slack
- [x] monitor multiple Pulsar clusters (with no kubernetes pods monitoring)
- [x] Co-resident Pulsar monitoring within Pulsar kubernetes cluster

This is a data driven tool that sources configuration from a yaml or json file. Here is a [template](../config/runtime_template.json).
The configuration json file can be specified in the overwrite order of 
- an environment variable `PULSAR_OPS_MONITOR_CFG`
- an command line argument `./pulsar-monitor -config /path/to/pulsar_ops_monitor_config.yml`
- A default path to `../config/runtime.yml`

## Observability
This tool exposes Prometheus compliant metrics at `\metrics` endpoint for scraping. The exported metrics are:

| Name | Type | Description |
|:------|:------:|:------------|
| pulsar_pubsub_latency_ms | gauge | end to end message pub and sub latency in millieseconds |
| pulsar_pubsub_latency_ms_hst | summary | end to end message latency histogram summary over 50%, 90%, and 99% samples |
| pulsar_websocket_latency_ms | gauge | end to end message pub and sub latency over websocket interface in millieseconds |
| pulsar_k8s_bookkeeper_offline_counter | gauge | bookkeeper offline instances in kubernetes cluster |
| pulsar_k8s_broker | gauge | broker offline instances in kubernetes cluster |
| pulsar_k8s_proxy_offline_counter | gauge | proxy offline instances in kubernetes cluster |
| pulsar_k8s_bookkeeper_zookeeper_counter | gauge | zookeeper offline instances in kubernets cluster |
| pulsar_monitor_counter | counter | pulsar monitor heartbeat counter |
| pulsar_tenant_size | gauge | the number of tenants that can be used as a health indicator of admin interface |

## In-cluster monitoring
Pulsar monitor can be deployed within the same Pulsar Kubernetes cluster. Kubernetes' pod and service , and individual broker monitoring are only supported within the same Kubernetes cluster deployment.


## Docker
Pulsar Monitor's official docker image can be pulled [here](https://hub.docker.com/repository/docker/kesque/pulsar-monitor)

### Docker compose
`./config/runtime.yml` or `./config/runtime.json` must have a Pulsar jwt and configured properly.

``` bash
$ docker-compose up
```

### Docker example
The runtime.json file must be mounted as /app/runtime.json

This runs a multi stage build that produces a 18MB docker image.
```
$ make
```

Run docker container with Pulsar CA certificate and expose Prometheus metrics for collection.

``` bash
$ docker run -d -it -v $HOME/go/src/github.com/kafkaesque-io/pulsar-monitor/config/runtime.yml:/config/runtime.yml -v /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-bundle.crt -p 8080:8080 --name=pulsar-monitor kesque/pulsar-monitor:1.2.91
```

If you are monitoring Pulsar cluster managed by Kesque, this is the command since we already include a certificate in the docker image.
``` bash
$ docker run -d -it -v $HOME/go/src/github.com/kafkaesque-io/pulsar-monitor/config/runtime.yml:/config/runtime.yml -p 8080:8080 --name=pulsar-monitor kesque/pulsar-monitor:1.1.1
```

## Helm chart
Here is Pulsar Monitor's [helm chart](https://github.com/kafkaesque-io/pulsar-helm-chart/tree/master/helm-chart-sources/pulsar-monitor)

### Install as an individual deployment using helm
Helm 3
```
helm3 install pulsar-monitor kafkaesque/pulsar --namespace monitoring --values ./config/helm-values/pulsar-monitor-values.yaml
```

Helm2
```
helm install kafkaesque/pulsar --name pulsar-monitor --namespace monitoring --values ./config/helm-values/pulsar-monitor-values.yaml
```

### Install as part of Kesque Pulsar cluster using helm

Pulsar Monitor can be directly enabled inside [the Kesque's Pulsar chart](https://github.com/kafkaesque-io/pulsar-helm-chart/blob/master/helm-chart-sources/pulsar/values.yaml#L1571)


## Development

### How to build
To create a binary under ./bin/pulsar-monitor, run this
```
$ ./scripts/ci.sh
```
